name: Deploy Frontend to Production

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    name: Deploy React App to Windows Server
    runs-on: self-hosted
    environment: production
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Sincronizar codigo completo desde runner
        run: |
          Write-Host "Sincronizando codigo desde runner workspace..." -ForegroundColor Cyan
          
          $runnerWorkspace = $env:GITHUB_WORKSPACE
          $targetPath = "C:\Projects\interface-layer"
          
          # Copiar archivos actualizados (excepto node_modules, build, .git)
          Get-ChildItem -Path $runnerWorkspace -Exclude @('node_modules', 'build', '.git') | ForEach-Object {
            $dest = Join-Path $targetPath $_.Name
            if ($_.PSIsContainer) {
              if (Test-Path $dest) { Remove-Item $dest -Recurse -Force }
              Copy-Item $_.FullName -Destination $dest -Recurse -Force
            } else {
              Copy-Item $_.FullName -Destination $dest -Force
            }
          }
          
          Write-Host "Codigo sincronizado" -ForegroundColor Green
        shell: powershell

      - name: Ejecutar build
        run: |
          cd C:\Projects\interface-layer
          Write-Host "Compilando proyecto..." -ForegroundColor Cyan
          npm install --no-audit --no-fund
          if ($LASTEXITCODE -ne 0) { exit 1 }
          $env:CI = "false"
          npm run build
          if ($LASTEXITCODE -ne 0) { exit 1 }
          Write-Host "Compilacion exitosa" -ForegroundColor Green
        shell: powershell

      - name: Verificar build
        run: |
          cd C:\Projects\interface-layer
          if (-Not (Test-Path "build\index.html")) {
            Write-Host "ERROR: No se genero el build" -ForegroundColor Red
            exit 1
          }
          $buildSize = (Get-ChildItem build -Recurse | Measure-Object -Property Length -Sum).Sum
          Write-Host "Build generado: $([math]::Round($buildSize/1MB, 2)) MB" -ForegroundColor Green
        shell: powershell

      - name: Desplegar build a servidor
        run: |
          cd C:\Projects\interface-layer
          Write-Host "Desplegando con Hot Reload..." -ForegroundColor Cyan
          .\scripts\deploy-frontend.ps1 -BuildPath "C:\Projects\interface-layer\build"
        shell: powershell

      - name: Verificar deployment
        run: |
          $test = Test-NetConnection -ComputerName localhost -Port 3000 -WarningAction SilentlyContinue
          if ($test.TcpTestSucceeded) {
            Write-Host "Frontend accesible en http://localhost:3000" -ForegroundColor Green
          } else {
            Write-Host "ADVERTENCIA: Servidor no responde en puerto 3000" -ForegroundColor Yellow
          }
        shell: powershell

      - name: Resumen
        run: |
          Write-Host "================================" -ForegroundColor Cyan
          Write-Host "DEPLOYMENT COMPLETADO" -ForegroundColor Green
          Write-Host "================================" -ForegroundColor Cyan
          Write-Host "URL: http://localhost:3000" -ForegroundColor Green
        shell: powershell
