name: Deploy Frontend to Production

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    name: Deploy React App to Windows Server
    runs-on: self-hosted
    environment: production
    
    steps:
      - name: Verificar ruta del proyecto
        run: |
          if (-Not (Test-Path C:\Projects\interface-layer)) {
            Write-Host "Error: La ruta no existe" -ForegroundColor Red
            exit 1
          }
          Write-Host "Ruta del proyecto verificada" -ForegroundColor Green
        shell: powershell

      - name: Pull latest changes
        run: |
          cd C:\Projects\interface-layer
          Write-Host "Descargando cambios desde GitHub..." -ForegroundColor Cyan
          git fetch origin
          git reset --hard origin/main
          Write-Host "Codigo actualizado desde GitHub" -ForegroundColor Green
          git log --oneline -1
        shell: powershell

      - name: Ejecutar build
        run: |
          cd C:\Projects\interface-layer
          Write-Host "Compilando proyecto..." -ForegroundColor Cyan
          npm install
          if ($LASTEXITCODE -ne 0) { exit 1 }
          $env:CI = "false"
          npm run build
          if ($LASTEXITCODE -ne 0) { exit 1 }
          Write-Host "Compilacion exitosa" -ForegroundColor Green
        shell: powershell

      - name: Verificar build
        run: |
          cd C:\Projects\interface-layer
          Write-Host "Verificando build generado..." -ForegroundColor Cyan
          if (Test-Path "build\index.html") {
            $buildSize = (Get-ChildItem build -Recurse | Measure-Object -Property Length -Sum).Sum
            Write-Host "Build generado exitosamente!" -ForegroundColor Green
            Write-Host "  Ubicacion: C:\Projects\interface-layer\build\" -ForegroundColor Cyan
            Write-Host "  Tamanio total: $([math]::Round($buildSize/1MB, 2)) MB" -ForegroundColor Cyan
          } else {
            Write-Host "ERROR: No se genero el build correctamente" -ForegroundColor Red
            exit 1
          }
        shell: powershell

      - name: Desplegar build a servidor
        run: |
          cd C:\Projects\interface-layer
          $serverPath = "C:\Projects\servers\red-negocios\frontend"
          
          Write-Host "Desplegando build al servidor..." -ForegroundColor Cyan
          
          # Crear directorio del servidor si no existe
          if (-Not (Test-Path $serverPath)) {
            New-Item -ItemType Directory -Path $serverPath -Force | Out-Null
            Write-Host "Directorio del servidor creado: $serverPath" -ForegroundColor Green
          }
          
          # Limpiar contenido anterior (excepto node_modules si existe)
          Write-Host "Limpiando deployment anterior..." -ForegroundColor Yellow
          Get-ChildItem $serverPath -Exclude node_modules | Remove-Item -Recurse -Force -ErrorAction SilentlyContinue
          
          # Copiar nuevo build
          Write-Host "Copiando archivos del build..." -ForegroundColor Cyan
          Copy-Item -Path "build\*" -Destination $serverPath -Recurse -Force
          
          Write-Host "Build desplegado exitosamente en: $serverPath" -ForegroundColor Green
          
          # Verificar archivos copiados
          $deployedFiles = (Get-ChildItem $serverPath -Recurse -File).Count
          Write-Host "Archivos desplegados: $deployedFiles" -ForegroundColor Cyan
        shell: powershell

      - name: Resumen del deployment
        run: |
          Write-Host "================================" -ForegroundColor Cyan
          Write-Host "DEPLOYMENT COMPLETADO" -ForegroundColor Green
          Write-Host "================================" -ForegroundColor Cyan
          Write-Host "Proyecto: C:\Projects\interface-layer" -ForegroundColor White
          Write-Host "Build desplegado en: C:\Projects\servers\red-negocios\frontend\" -ForegroundColor White
          Write-Host ""
          Write-Host "PROXIMO PASO:" -ForegroundColor Yellow
          Write-Host "Inicia el servidor frontend si no esta corriendo:" -ForegroundColor Yellow
          Write-Host '  cd "C:\Projects\servers\red-negocios\frontend"' -ForegroundColor White
          Write-Host "  npx serve -s . -l 3000" -ForegroundColor White
          Write-Host ""
          Write-Host "O reinicia el servidor si ya estaba corriendo para aplicar cambios" -ForegroundColor Yellow
          Write-Host ""
          Write-Host "URL: http://localhost:3000" -ForegroundColor Green
          Write-Host "================================" -ForegroundColor Cyan
        shell: powershell
